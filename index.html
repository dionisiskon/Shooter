<!DOCTYPE HTML>
<html>
<head>
<title>Shooter</title>
<meta charset="utf-8">
<style type="text/css">
body {
	margin: 0;
	padding: 0;
	background-color: #000;
}
</style>
<script src="menu.js"></script>
<script src="lvl1.js"></script>
<script src="//cdn.jsdelivr.net/phaser/2.6.2/phaser.min.js"
	type="text/javascript"></script>
</head>
<body>
	<script type="text/javascript">
		var game = new Phaser.Game(800, 600, Phaser.AUTO, 'phaser-demo',this);

		var player;
		var villains;
		var villains1;
		var enemyBullets;
		var starfield;
		var cursors;
		var bank;
		var shipTrail;
		var explosions;
		var bullets;
		var fireButton;
		var bulletTimer = 0;
		var shield;
		var score = 0;
		var scoreText;
		var EnemyLaunchTimer;
		var EnemySpacing = 1000;
		var Enemy2LaunchTimer;
		var EnemyLaunched = false;
		var gameOver;

		var ACCLERATION = 600;
		var DRAG = 400;
		var MAXSPEED = 400;

		 function preload() {

		// 	//  We need this because the assets are on github pages
		// 	//  Remove the next 2 lines if running locally
		 	    game.load.baseURL = 'https://dionisiskon.github.io/Shooter/';
		 	    game.load.crossOrigin = 'anonymous';

		 }

		 game.state.add('lvl1',lvl1);
		 game.state.add('menu',menu);
		 game.state.start('menu');
	

		function fireBullet() {
			 switch (player.weaponLevel) {
        	 case 1:
        	 //  To avoid them being allowed to fire too fast we set a time limit
        	 if (game.time.now > bulletTimer)
        	 {
			var BULLET_SPEED = 400;
           	 	var BULLET_SPACING = 250;
            		//  Grab the first bullet we can from the pool
            		var bullet = bullets.getFirstExists(false);

            	if (bullet)
            	{
                	//  And fire it
                	//  Make bullet come out of tip of ship with right angle
                	var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
                	bullet.reset(player.x + bulletOffset, player.y);
                	bullet.angle = player.angle;
                	game.physics.arcade.velocityFromAngle(bullet.angle, BULLET_SPEED, bullet.body.velocity);
                	bullet.body.velocity.y += player.body.velocity.y;

                	bulletTimer = game.time.now + BULLET_SPACING;
            	}
        	}
        	break;

        case 2:
        if (game.time.now > bulletTimer) {
            var BULLET_SPEED = 400;
            var BULLET_SPACING = 550;


            for (var i = 0; i < 3; i++) {
                var bullet = bullets.getFirstExists(false);
                if (bullet) {
                    //  Make bullet come out of tip of ship with right angle
                    var bulletOffset = 20 * Math.sin(game.math.degToRad(player.angle));
                    bullet.reset(player.x + bulletOffset, player.y);
                   //  "Spread" angle of 1st and 3rd bullets
                    var spreadAngle;
                    if (i === 0) spreadAngle = -20;
                    if (i === 1) spreadAngle = 0;
                    if (i === 2) spreadAngle = 20;
                    bullet.angle = player.angle + spreadAngle;
                    game.physics.arcade.velocityFromAngle(spreadAngle , BULLET_SPEED, bullet.body.velocity);
                    bullet.body.velocity.y += player.body.velocity.y;
                }
               bulletTimer = game.time.now + BULLET_SPACING;
           			}
				}
			}
		}

		function launchEnemy() {
			var ENEMY_SPEED = 400;

			var enemy = villains.getFirstExists(false);
			if (enemy) {
			enemy.reset(800,game.rnd.integerInRange(game.width, 300));
			enemy.body.velocity.x = -ENEMY_SPEED;
			enemy.body.velocity.y = game.rnd.integerInRange(0,-100);
        		enemy.body.drag.y = 100;
			enemy.trail.start(false, 800, 1);
			
			//  Update function for each enemy ship to update rotation etc
			enemy.update = function(){
			enemy.angle = 270 - game.math.radToDeg(Math.atan2(enemy.body.velocity.x, enemy.body.velocity.y));
			
			enemy.trail.x = enemy.x;
			enemy.trail.y = enemy.y -10;
			
			//  Kill enemies once they go off screen
			if (enemy.y > game.height ) {
				enemy.kill();
				}
			}
		}
			//  Send another enemy soon
			 EnemyLaunchTimer = game.time.events.add(game.rnd.integerInRange(EnemySpacing,EnemySpacing + 1000), launchEnemy);
	    }

		function launch2Enemy() {
    	  	var startingX = game.rnd.integerInRange(250, game.width / 2);
    	  	var verticalSpeed = 180;
    	  	var spread = 60;
    	  	var frequency = 70;
    	  	var verticalSpacing = 70;
    	  	var numEnemiesInWave = 5;
    	  	var timeBetweenWaves = 2500;
    	  
   	   	  //  Launch wave
    	      	  for (var i =0; i < numEnemiesInWave; i++) {
                  var enemy = villains1.getFirstExists(false);
                  if (enemy) {
                	enemy.startingX = startingX;
                	enemy.reset(game.width + (verticalSpacing*i), game.height );
                	enemy.body.velocity.x = -verticalSpeed;

                //  Set up firing
            	var bulletSpeed = 400;
            	var firingDelay = 2000;
            	enemy.bullets = 5;
            	enemy.lastShot = 0;
        
              //  Update function for each enemy
              enemy.update = function(){
              //  Wave movement
              this.body.y = this.startingX + Math.sin((this.x) / frequency) * spread;

              //  Squish and rotate ship for illusion of "banking"
              bank = Math.cos((this.y + 60) / frequency)
              this.scale.y = 0.5 - Math.abs(bank) / 8;
              this.angle = 360 - bank * 2;

               //  Fire
               enemyBullet = enemyBullets.getFirstExists(false);
              if (enemyBullet &&
                    this.alive &&
                    this.bullets &&
                    this.x < game.width &&
                    game.time.now > firingDelay + this.lastShot) {
                    this.lastShot = game.time.now;
                    this.bullets--;
                    enemyBullet.reset(this.x, this.y + this.height / 2);
                    enemyBullet.damageAmount = this.damageAmount;
                    var angle = game.physics.arcade.moveToObject(enemyBullet, player, bulletSpeed);
                    enemyBullet.angle = game.math.radToDeg(angle);
                    //enemys=game.add.audio('v1sound');
		    //enemys.play();
                }

              //  Kill enemies once they go off screen
              if (this.y > game.height + 200) {
                this.kill();
                this.y = -20
              }
            };
        }
    }
    
   		//  Send another wave soon
   		Enemy2LaunchTimer = game.time.events.add(game.rnd.integerInRange(timeBetweenWaves, timeBetweenWaves + 4000), launch2Enemy);
	}

		function addEnemyEmitterTrail(enemy) {
			var enemyTrail = game.add.emitter(enemy.x, player.y - 10, 100);
			enemyTrail.width = 10;
			enemyTrail.makeParticles('explosion', [1,2,3,4,5]);
			enemyTrail.setXSpeed(20, -20);
			enemyTrail.setRotation(50,-50);
			enemyTrail.setAlpha(0.4, 0, 800);
			enemyTrail.setScale(0.01, 0.1, 0.01, 0.1, 1000, Phaser.Easing.Quintic.Out);
			enemy.trail = enemyTrail;
		}
		
		function shipCollide(player, enemy) {
			var explosion = explosions.getFirstExists(false);
			explosion.reset(enemy.body.x + enemy.body.halfWidth, enemy.body.y + enemy.body.halfHeight);
			explosion.body.velocity.y = enemy.body.velocity.y;
			explosion.alpha = 0.7;
			explosion.play('explosion', 30, false, true);
			enemy.kill();
			
			player.damage(enemy.damageAmount);
			shield.render();
			booms=game.add.audio('boom');
			booms.play();
		}
		
		function hitEnemy(enemy, bullet) {
			var explosion = explosions.getFirstExists(false);
			explosion.reset(bullet.body.x + bullet.body.halfWidth, bullet.body.y + bullet.body.halfHeight);
			explosion.body.velocity.y = enemy.body.velocity.y;
			explosion.alpha = 0.7;
			explosion.play('explosion', 30, false, true);
			enemy.kill();
			bullet.kill();
			// Increase score
			score += enemy.damageAmount * 10;
			scoreText.render()
			booms=game.add.audio('boom');
			booms.play();

			//  Pacing
    			//  Enemies come quicker as score increases
    			EnemySpacing *= 0.9;
   			//  Second enemies come in after a score of 1000
    			if (!EnemyLaunched && score > 1000) {
      				EnemyLaunched = true;
      				launch2Enemy();
      			//  Slows first enemies down now that there are other enemies
      			EnemySpacing *= 2;
    			}

    		//  Weapon upgrade
     		if (score > 4000 && player.weaponLevel < 2) {
      	    		player.weaponLevel = 2;
     			}
 		}	
		
		function enemyHitsPlayer (player, bullet) {
    			var explosion = explosions.getFirstExists(false);
    			explosion.reset(player.body.x + player.body.halfWidth, player.body.y + player.body.halfHeight);
    			explosion.alpha = 0.7;
    			explosion.play('explosion', 30, false, true);
    			bullet.kill();

    			player.damage(bullet.damageAmount);
    			shield.render();
    		}
		
	
		
		function restart () {
			//  Reset the enemies
			villains.callAll('kill');
			game.time.events.remove(EnemyLaunchTimer);
			game.time.events.remove(Enemy2LaunchTimer);
			game.time.events.add(1000, launchEnemy);
			villains1.callAll('kill');
			enemyBullets.callAll('kill');
			game.time.events.remove(Enemy2LaunchTimer);
			
			villains1.callAll('kill');
			game.time.events.remove(Enemy2LaunchTimer);
			//  Revive the player
			player.weaponLevel = 1;
			player.revive();
			player.health = 100;
			shield.render();
			score = 0;
			scoreText.render();

			//  Hide the text
			gameOver.visible = false;

			//  Reset pacing
    			EnemySpacing = 1000;
    			EnemyLaunched = false;

		}
	</script>
</body>
</html>
